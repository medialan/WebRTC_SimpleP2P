<!DOCTYPE html>
<html>
<head>
	<!--
		xxx noch nicht komplett ausimplementiert. Ziel ist die minimalen p2p samples noch weiter zu reduzieren, 
		xxx so dass der kleinste "code" entsteht, der eine p2p Verbindung herstellen kann
	
		Test Documentation:
			- weitere Minimierung des P2P Szenarios
				* es wird KEINE Unterscheidung zwischen "caller" und "callee" benötigt, da die sdp Signalisierungen
				  bereits die Information enthalten ob es sich um ein "offer" oder eine "answer" handelt. Damit kann
				  auf dieser Basis ein unterschiedliches Verhalten von Caller und Callee implementiert werden
				* GUM wird statisch gerufen unabhängig von caller oder callee - alle für den RTC Verbindungsaufbau
				  notwendigen Dinge werden soweit möglich statisch realisiert (nicht erst wenn ein Call eingeht oder gestartet wird)
				  z. B. ...

		- uses SERVER02
	-->

	<link rel="stylesheet" href="diag.css">
	
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	<script>
		// ********************************
		// Socket.IO based signaling server
		// ********************************
		var SignalingServer = {
			socket : null,
			
			Connect: function (cb) {
				this.socket = io.connect("http://" + location.hostname + ":7002");
				this.socket.on('msg', function (msg) {
					cb(msg);
				});
			},
						
			Send: function(msg) {
				this.socket.emit('msg',msg);
			}
		};		
	</script>
		
		
		<script>
		
// WebRTC P2P Tests
// - code parts which are independent from type of transport of the signaling data
// - SignalingServer object is not implemented here. 

var locVid;
var remVid;
var isCaller = false;

var pc        = null;
var locstream = null;
				
// static init
$(document).ready(function() {
	locVid = $("#locvideo");
	remVid = $("#remvideo");
	SignalingServer.Connect(onSignaling);

	pc = new webkitRTCPeerConnection({iceServers: [{url: 'stun:nostunserver.com:19302'}]});		// fake url, we do not need a STUN server here
	pc.onicecandidate = onIceCandidate;			// install handler for local ICE candidates
	pc.onaddstream    = onAddStream;
	
	function onGotStream(stream) {
		locstream = stream;
		locVid.attr("src",window.URL.createObjectURL(stream));	
		pc.addStream(stream);
	};
	
	navigator.webkitGetUserMedia({video:true, audio:true}, onGotStream, onFailed);	
});

function onFailed() {
	console.log("ERROR");
};

function onIceCandidate(event) {
	if (event.candidate == null) return;
	SignalingServer.Send(JSON.stringify({'candidate':event.candidate}));
};

function onAddStream(event) {
	remVid.attr("src",window.URL.createObjectURL(event.stream));
};		

function SendSDP(data) {
	pc.setLocalDescription(data);
	var msg = JSON.stringify({'sdp':data});
	SignalingServer.Send(msg);							
};

function Dial() {
	pc.createOffer(SendSDP);
};

function onSignaling(msg) {			
	var signal = JSON.parse(msg);
	if (signal.sdp) {
		pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));		
		if (signal.sdp.type == "offer") pc.createAnswer(SendSDP);
	} else if (signal.candidate) {
		pc.addIceCandidate(new RTCIceCandidate(signal.candidate));			
	};
};
		
		
	</script>	
</head>

<body>
	<h2>Peer2Peer connection - Socket.IO signaling</h2>
	<div>
		<div style="margin-right:20px; width:250px;">
			<button onclick="Dial();" style="width:80px;">Dial</button><br />						
		</div>
		<div style="width:270px; margin-right:20px;">
			<table>
				<tr>
					<td><span style="font-weight:bold">local</span></td>
					<td><span style="font-weight:bold">remote</span></td>
				</tr>
				<tr>
					<td>
						<video id="locvideo" autoplay="autoplay" style="width:128px; height:96px; border:1px solid black;"></video>
					</td>
					<td>
						<video id="remvideo" autoplay="autoplay" style="width:128px; height:96px; border:1px solid black;"></video>			
					</td>
				<tr>
			</table>
		</div>				
	</div>	
</body>
</html>
